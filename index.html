<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Home Energy Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f4f7f6; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .controls { text-align: center; margin-bottom: 20px; }
        select { padding: 8px 16px; font-size: 1em; border-radius: 4px; border: 1px solid #bdc3c7; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; }
        h2 { color: #34495e; font-size: 1.2em; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 0; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Total Home Energy Dashboard</h1>

        <div class="controls">
            <label for="yearSelect"><strong>Filter by Year: </strong></label>
            <select id="yearSelect">
                <option value="all">All Time</option>
            </select>
        </div>

        <!-- 1. Total Monthly Energy Spend -->
        <div class="card">
            <h2>üí∞ Total Monthly Energy Spend (Where is the money going?)</h2>
            <div class="chart-container">
                <canvas id="totalCostChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                Combined cost of Gas, Electric (National Grid), and Solar (Sunrun).
            </p>
        </div>

        <!-- 2. Total Home Energy Usage -->
        <div class="card">
            <h2>‚ö° Total Home Energy Usage (Gas + Electric)</h2>
            <div class="chart-container">
                <canvas id="totalEnergyChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                Comparison of total energy usage from Gas vs. Electricity. (* Gas converted to kWh: 1 Therm = 29.3 kWh)
            </p>
        </div>

        <!-- 3. Net Zero Tracker -->
        <div class="card">
            <h2>‚öñÔ∏è Net Zero Tracker</h2>
            <div class="chart-container">
                <canvas id="netZeroChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                Solar Production (Yellow) vs. True Consumption (Blue Line). If Yellow > Blue, you are Net Zero.
            </p>
        </div>

        <!-- 4. Total Home Consumption (Electric Only) -->
        <div class="card">
            <h2>üè† Home Electric Consumption</h2>

            <div class="chart-container">
                <canvas id="consumptionChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666;">
                <strong>Blue:</strong> Power bought from Grid. <strong>Green:</strong> Solar power used directly. 
                <br>The total height is your real home usage.
            </p>
        </div>

        <!-- 5. Monthly Electric Costs (Grid + Solar) -->
        <div class="card">
            <h2>üíµ Monthly Electric Costs (Grid + Solar)</h2>
            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                Combined cost of National Grid and Sunrun bills.
            </p>
        </div>

        <!-- 6. Solar Utilization -->
        <div class="card">
            <h2>‚òÄÔ∏è Solar Utilization (Where did the power go?)</h2>
            <div class="chart-container">
                <canvas id="utilizationChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                How your solar generation was used: Consumed at home (yellow) vs. Exported to grid (grey).
            </p>
        </div>

        <!-- 7. Credit Bank -->
        <div class="card">
            <h2>üí∞ National Grid Credit Bank</h2>
            <div class="chart-container">
                <canvas id="creditChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                Rolling balance of net metering credits ($) accumulated with National Grid.
            </p>
        </div>

        <!-- 8. Effective Rate -->
        <div class="card">
            <h2>üìâ Effective Cost per kWh</h2>
            <div class="chart-container">
                <canvas id="rateChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                The true 'blended' cost per kWh (Total Electric Cost / True Consumption).
            </p>
        </div>

        <!-- 9. Production Source Comparison -->
        <div class="card">
            <h2>üîç Solar Production Source Comparison</h2>
            <div class="chart-container">
                <canvas id="productionComparisonChart"></canvas>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                Comparison of what Sunrun says you produced vs. what National Grid credited you for.
            </p>
        </div>

    </div>

    <script>
        const allData = [{"month":"2021-03","ngStartDate":"2021-03-15","ngEndDate":"2021-04-14","ngCost":205.71,"ngUsage":751,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":751,"netPosition":-751,"totalCost":205.71,"effectiveRate":0.27391478029294275,"gasKwh":0,"totalEnergyCost":205.71,"totalEnergyKwh":751,"billingPeriodProd":0},{"month":"2021-04","ngStartDate":"2021-04-14","ngEndDate":"2021-05-13","ngCost":134.52,"ngUsage":512,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":512,"netPosition":-512,"totalCost":134.52,"effectiveRate":0.262734375,"gasKwh":0,"totalEnergyCost":134.52,"totalEnergyKwh":512,"billingPeriodProd":0},{"month":"2021-05","ngStartDate":"2021-05-13","ngEndDate":"2021-06-11","ngCost":200.24,"ngUsage":833,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":833,"netPosition":-833,"totalCost":200.24,"effectiveRate":0.2403841536614646,"gasKwh":0,"totalEnergyCost":200.24,"totalEnergyKwh":833,"billingPeriodProd":0},{"month":"2021-06","ngStartDate":"2021-06-11","ngEndDate":"2021-07-14","ngCost":317.52,"ngUsage":1322,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":1322,"netPosition":-1322,"totalCost":317.52,"effectiveRate":0.24018154311649015,"gasKwh":0,"totalEnergyCost":317.52,"totalEnergyKwh":1322,"billingPeriodProd":0},{"month":"2021-07","ngStartDate":"2021-07-14","ngEndDate":"2021-08-13","ngCost":231.48,"ngUsage":955,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":955,"netPosition":-955,"totalCost":231.48,"effectiveRate":0.2423874345549738,"gasKwh":0,"totalEnergyCost":231.48,"totalEnergyKwh":955,"billingPeriodProd":0},{"month":"2021-08","ngStartDate":"2021-08-13","ngEndDate":"2021-09-15","ngCost":262.76,"ngUsage":1088,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":1088,"netPosition":-1088,"totalCost":262.76,"effectiveRate":0.24150735294117645,"gasKwh":0,"totalEnergyCost":262.76,"totalEnergyKwh":1088,"billingPeriodProd":0},{"month":"2021-09","ngStartDate":"2021-09-15","ngEndDate":"2021-10-12","ngCost":170.06,"ngUsage":694,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":694,"netPosition":-694,"totalCost":170.06,"effectiveRate":0.24504322766570605,"gasKwh":0,"totalEnergyCost":170.06,"totalEnergyKwh":694,"billingPeriodProd":0},{"month":"2021-10","ngStartDate":"2021-10-12","ngEndDate":"2021-11-12","ngCost":202.24,"ngUsage":766,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":766,"netPosition":-766,"totalCost":202.24,"effectiveRate":0.26402088772845955,"gasKwh":0,"totalEnergyCost":202.24,"totalEnergyKwh":766,"billingPeriodProd":0},{"month":"2021-11","ngStartDate":"2021-11-12","ngEndDate":"2021-12-14","ngCost":264.24,"ngUsage":898,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":898,"netPosition":-898,"totalCost":264.24,"effectiveRate":0.2942538975501114,"gasKwh":0,"totalEnergyCost":264.24,"totalEnergyKwh":898,"billingPeriodProd":0},{"month":"2021-12","ngStartDate":"2021-12-14","ngEndDate":"2022-01-12","ngCost":207.69,"ngUsage":700,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":700,"netPosition":-700,"totalCost":207.69,"effectiveRate":0.2967,"gasKwh":0,"totalEnergyCost":207.69,"totalEnergyKwh":700,"billingPeriodProd":0},{"month":"2022-01","ngStartDate":"2022-01-12","ngEndDate":"2022-02-10","ngCost":188.17,"ngUsage":631,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":631,"netPosition":-631,"totalCost":188.17,"effectiveRate":0.2982091917591125,"gasKwh":0,"totalEnergyCost":188.17,"totalEnergyKwh":631,"billingPeriodProd":0},{"month":"2022-02","ngStartDate":"2022-02-10","ngEndDate":"2022-03-11","ngCost":229.9,"ngUsage":781,"ngExport":0,"ngCredit":0,"ngProd":0,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":0,"selfUse":0,"trueConsumption":781,"netPosition":-781,"totalCost":229.9,"effectiveRate":0.2943661971830986,"gasKwh":0,"totalEnergyCost":229.9,"totalEnergyKwh":781,"billingPeriodProd":0},{"month":"2022-03","ngStartDate":"2022-03-11","ngEndDate":"2022-04-12","ngCost":20.38,"ngUsage":0,"ngExport":39,"ngCredit":0,"ngProd":760,"sunrunCost":140.68,"sunrunProd":820,"gasCost":0,"gasTherms":0,"totalProduction":724,"selfUse":685,"trueConsumption":685,"netPosition":39,"totalCost":161.06,"effectiveRate":0.23512408759124087,"gasKwh":0,"totalEnergyCost":161.06,"totalEnergyKwh":685,"billingPeriodProd":724},{"month":"2022-04","ngStartDate":"2022-04-12","ngEndDate":"2022-05-13","ngCost":0,"ngUsage":0,"ngExport":602,"ngCredit":139.65,"ngProd":1223,"sunrunCost":140.68,"sunrunProd":1252,"gasCost":0,"gasTherms":0,"totalProduction":1282,"selfUse":680,"trueConsumption":680,"netPosition":602,"totalCost":140.68,"effectiveRate":0.2068823529411765,"gasKwh":0,"totalEnergyCost":140.68,"totalEnergyKwh":680,"billingPeriodProd":1282},{"month":"2022-05","ngStartDate":"2022-05-13","ngEndDate":"2022-06-14","ngCost":0,"ngUsage":0,"ngExport":1030,"ngCredit":366.18,"ngProd":1528,"sunrunCost":140.68,"sunrunProd":1443,"gasCost":0,"gasTherms":0,"totalProduction":1512,"selfUse":482,"trueConsumption":482,"netPosition":1030,"totalCost":140.68,"effectiveRate":0.2918672199170125,"gasKwh":0,"totalEnergyCost":140.68,"totalEnergyKwh":482,"billingPeriodProd":1512},{"month":"2022-06","ngStartDate":"2022-06-14","ngEndDate":"2022-07-14","ngCost":0,"ngUsage":0,"ngExport":633,"ngCredit":500.66,"ngProd":1488,"sunrunCost":140.68,"sunrunProd":1477,"gasCost":0,"gasTherms":0,"totalProduction":1538,"selfUse":905,"trueConsumption":905,"netPosition":633,"totalCost":140.68,"effectiveRate":0.15544751381215471,"gasKwh":0,"totalEnergyCost":140.68,"totalEnergyKwh":905,"billingPeriodProd":1538},{"month":"2022-07","ngStartDate":"2022-07-14","ngEndDate":"2022-08-15","ngCost":116.73,"ngUsage":410,"ngExport":0,"ngCredit":383.93,"ngProd":1364,"sunrunCost":140.68,"sunrunProd":1332,"gasCost":0,"gasTherms":0,"totalProduction":1427,"selfUse":1427,"trueConsumption":1837,"netPosition":-410,"totalCost":257.41,"effectiveRate":0.1401252041371802,"gasKwh":0,"totalEnergyCost":257.41,"totalEnergyKwh":1837,"billingPeriodProd":1427},{"month":"2022-08","ngStartDate":"2022-08-15","ngEndDate":"2022-09-14","ngCost":0,"ngUsage":0,"ngExport":81,"ngCredit":392.29,"ngProd":961,"sunrunCost":140.68,"sunrunProd":977,"gasCost":0,"gasTherms":0,"totalProduction":981,"selfUse":900,"trueConsumption":900,"netPosition":81,"totalCost":140.68,"effectiveRate":0.15631111111111112,"gasKwh":0,"totalEnergyCost":140.68,"totalEnergyKwh":900,"billingPeriodProd":981},{"month":"2022-09","ngStartDate":"2022-09-14","ngEndDate":"2022-10-11","ngCost":0,"ngUsage":0,"ngExport":66,"ngCredit":398.77,"ngProd":579,"sunrunCost":140.68,"sunrunProd":608,"gasCost":0,"gasTherms":0,"totalProduction":592,"selfUse":526,"trueConsumption":526,"netPosition":66,"totalCost":140.68,"effectiveRate":0.26745247148288975,"gasKwh":0,"totalEnergyCost":140.68,"totalEnergyKwh":526,"billingPeriodProd":592},{"month":"2022-10","ngStartDate":"2022-10-11","ngEndDate":"2022-11-15","ngCost":16.8,"ngUsage":23,"ngExport":0,"ngCredit":381.97,"ngProd":524,"sunrunCost":140.68,"sunrunProd":451,"gasCost":0,"gasTherms":0,"totalProduction":532,"selfUse":532,"trueConsumption":555,"netPosition":-23,"totalCost":157.48000000000002,"effectiveRate":0.2837477477477478,"gasKwh":0,"totalEnergyCost":157.48000000000002,"totalEnergyKwh":555,"billingPeriodProd":532},{"month":"2022-11","ngStartDate":"2022-11-15","ngEndDate":"2022-12-14","ngCost":57.98,"ngUsage":105,"ngExport":0,"ngCredit":323.99,"ngProd":332,"sunrunCost":140.68,"sunrunProd":358,"gasCost":0,"gasTherms":0,"totalProduction":358,"selfUse":358,"trueConsumption":463,"netPosition":-105,"totalCost":198.66,"effectiveRate":0.42907127429805614,"gasKwh":0,"totalEnergyCost":198.66,"totalEnergyKwh":463,"billingPeriodProd":358},{"month":"2022-12","ngStartDate":"2022-12-14","ngEndDate":"2023-01-12","ngCost":76.9,"ngUsage":145,"ngExport":0,"ngCredit":247.09,"ngProd":296,"sunrunCost":140.68,"sunrunProd":296,"gasCost":0,"gasTherms":0,"totalProduction":311,"selfUse":311,"trueConsumption":456,"netPosition":-145,"totalCost":217.58,"effectiveRate":0.47714912280701754,"gasKwh":0,"totalEnergyCost":217.58,"totalEnergyKwh":456,"billingPeriodProd":311},{"month":"2023-01","ngStartDate":"2023-01-12","ngEndDate":"2023-02-10","ngCost":75.23,"ngUsage":141,"ngExport":0,"ngCredit":171.86,"ngProd":333,"sunrunCost":140.68,"sunrunProd":407,"gasCost":0,"gasTherms":0,"totalProduction":336,"selfUse":336,"trueConsumption":477,"netPosition":-141,"totalCost":215.91000000000003,"effectiveRate":0.4526415094339623,"gasKwh":0,"totalEnergyCost":215.91000000000003,"totalEnergyKwh":477,"billingPeriodProd":336},{"month":"2023-02","ngStartDate":"2023-02-10","ngEndDate":"2023-03-13","ngCost":0,"ngUsage":0,"ngExport":82,"ngCredit":200.36,"ngProd":547,"sunrunCost":140.68,"sunrunProd":477,"gasCost":388.32,"gasTherms":182,"totalProduction":559,"selfUse":477,"trueConsumption":477,"netPosition":82,"totalCost":140.68,"effectiveRate":0.2949266247379455,"gasKwh":5332.6,"totalEnergyCost":529,"totalEnergyKwh":5809.6,"billingPeriodProd":559},{"month":"2023-03","ngStartDate":"2023-03-13","ngEndDate":"2023-04-14","ngCost":0,"ngUsage":0,"ngExport":634,"ngCredit":481.51,"ngProd":1010,"sunrunCost":144.76,"sunrunProd":1000,"gasCost":248.74,"gasTherms":143,"totalProduction":998,"selfUse":364,"trueConsumption":364,"netPosition":634,"totalCost":144.76,"effectiveRate":0.3976923076923077,"gasKwh":4189.900000000001,"totalEnergyCost":393.5,"totalEnergyKwh":4553.900000000001,"billingPeriodProd":998},{"month":"2023-04","ngStartDate":"2023-04-14","ngEndDate":"2023-05-12","ngCost":0,"ngUsage":0,"ngExport":658,"ngCredit":718.34,"ngProd":977,"sunrunCost":144.76,"sunrunProd":1089,"gasCost":107.45,"gasTherms":58,"totalProduction":1012,"selfUse":354,"trueConsumption":354,"netPosition":658,"totalCost":144.76,"effectiveRate":0.40892655367231634,"gasKwh":1699.4,"totalEnergyCost":252.20999999999998,"totalEnergyKwh":2053.4,"billingPeriodProd":1012},{"month":"2023-05","ngStartDate":"2023-05-12","ngEndDate":"2023-06-13","ngCost":0,"ngUsage":0,"ngExport":1206,"ngCredit":1023.37,"ngProd":1538,"sunrunCost":144.76,"sunrunProd":1476,"gasCost":62.33,"gasTherms":35,"totalProduction":1590,"selfUse":384,"trueConsumption":384,"netPosition":1206,"totalCost":144.76,"effectiveRate":0.37697916666666664,"gasKwh":1025.5,"totalEnergyCost":207.08999999999997,"totalEnergyKwh":1409.5,"billingPeriodProd":1590},{"month":"2023-06","ngStartDate":"2023-06-13","ngEndDate":"2023-07-13","ngCost":0,"ngUsage":0,"ngExport":313,"ngCredit":1091.61,"ngProd":1249,"sunrunCost":144.76,"sunrunProd":1224,"gasCost":51.09,"gasTherms":28,"totalProduction":1278,"selfUse":965,"trueConsumption":965,"netPosition":313,"totalCost":144.76,"effectiveRate":0.15001036269430051,"gasKwh":820.4,"totalEnergyCost":195.85,"totalEnergyKwh":1785.4,"billingPeriodProd":1278},{"month":"2023-07","ngStartDate":"2023-07-13","ngEndDate":"2023-08-11","ngCost":0,"ngUsage":0,"ngExport":194,"ngCredit":1125.33,"ngProd":1177,"sunrunCost":144.76,"sunrunProd":1275,"gasCost":44.08,"gasTherms":23,"totalProduction":1231,"selfUse":1037,"trueConsumption":1037,"netPosition":194,"totalCost":144.76,"effectiveRate":0.13959498553519767,"gasKwh":673.9,"totalEnergyCost":188.83999999999997,"totalEnergyKwh":1710.9,"billingPeriodProd":1231},{"month":"2023-08","ngStartDate":"2023-08-11","ngEndDate":"2023-09-13","ngCost":0,"ngUsage":0,"ngExport":92,"ngCredit":1133.65,"ngProd":970,"sunrunCost":144.76,"sunrunProd":881,"gasCost":42.7,"gasTherms":22,"totalProduction":1026,"selfUse":934,"trueConsumption":934,"netPosition":92,"totalCost":144.76,"effectiveRate":0.15498929336188436,"gasKwh":644.6,"totalEnergyCost":187.45999999999998,"totalEnergyKwh":1578.6,"billingPeriodProd":1026},{"month":"2023-09","ngStartDate":"2023-09-13","ngEndDate":"2023-10-12","ngCost":0,"ngUsage":0,"ngExport":249,"ngCredit":1189,"ngProd":564,"sunrunCost":144.76,"sunrunProd":590,"gasCost":48.25,"gasTherms":26,"totalProduction":603,"selfUse":354,"trueConsumption":354,"netPosition":249,"totalCost":144.76,"effectiveRate":0.40892655367231634,"gasKwh":761.8000000000001,"totalEnergyCost":193.01,"totalEnergyKwh":1115.8000000000002,"billingPeriodProd":603},{"month":"2023-10","ngStartDate":"2023-10-12","ngEndDate":"2023-11-10","ngCost":0,"ngUsage":0,"ngExport":200,"ngCredit":1236,"ngProd":419,"sunrunCost":144.76,"sunrunProd":425,"gasCost":62.1,"gasTherms":36,"totalProduction":433,"selfUse":233,"trueConsumption":233,"netPosition":200,"totalCost":144.76,"effectiveRate":0.6212875536480686,"gasKwh":1054.8,"totalEnergyCost":206.85999999999999,"totalEnergyKwh":1287.8,"billingPeriodProd":433},{"month":"2023-11","ngStartDate":"2023-11-10","ngEndDate":"2023-12-13","ngCost":44.74,"ngUsage":99,"ngExport":0,"ngCredit":1191.26,"ngProd":401,"sunrunCost":144.76,"sunrunProd":358,"gasCost":256.07,"gasTherms":138,"totalProduction":399,"selfUse":399,"trueConsumption":498,"netPosition":-99,"totalCost":189.5,"effectiveRate":0.38052208835341367,"gasKwh":4043.4,"totalEnergyCost":445.57,"totalEnergyKwh":4541.4,"billingPeriodProd":399},{"month":"2023-12","ngStartDate":"2023-12-13","ngEndDate":"2024-01-13","ngCost":55.6,"ngUsage":134,"ngExport":0,"ngCredit":1135.66,"ngProd":354,"sunrunCost":144.76,"sunrunProd":352,"gasCost":302.11,"gasTherms":163,"totalProduction":377,"selfUse":377,"trueConsumption":511,"netPosition":-134,"totalCost":200.35999999999999,"effectiveRate":0.39209393346379645,"gasKwh":4775.900000000001,"totalEnergyCost":502.47,"totalEnergyKwh":5286.900000000001,"billingPeriodProd":377},{"month":"2024-01","ngStartDate":"2024-01-13","ngEndDate":"2024-02-12","ngCost":73.74,"ngUsage":191,"ngExport":0,"ngCredit":1061.92,"ngProd":313,"sunrunCost":144.76,"sunrunProd":325,"gasCost":439.29,"gasTherms":250,"totalProduction":329,"selfUse":329,"trueConsumption":520,"netPosition":-191,"totalCost":218.5,"effectiveRate":0.4201923076923077,"gasKwh":7325,"totalEnergyCost":657.79,"totalEnergyKwh":7845,"billingPeriodProd":329},{"month":"2024-02","ngStartDate":"2024-02-12","ngEndDate":"2024-03-13","ngCost":299.81,"ngUsage":839,"ngExport":0,"ngCredit":762.11,"ngProd":625,"sunrunCost":144.76,"sunrunProd":660,"gasCost":253.41,"gasTherms":142,"totalProduction":633,"selfUse":633,"trueConsumption":1472,"netPosition":-839,"totalCost":444.57,"effectiveRate":0.30201766304347827,"gasKwh":4160.6,"totalEnergyCost":697.98,"totalEnergyKwh":5632.6,"billingPeriodProd":633},{"month":"2024-03","ngStartDate":"2024-03-13","ngEndDate":"2024-04-10","ngCost":104.94,"ngUsage":265,"ngExport":0,"ngCredit":657.17,"ngProd":819,"sunrunCost":148.96,"sunrunProd":865,"gasCost":35.98,"gasTherms":14,"totalProduction":862,"selfUse":862,"trueConsumption":1127,"netPosition":-265,"totalCost":253.9,"effectiveRate":0.22528837622005324,"gasKwh":410.2,"totalEnergyCost":289.88,"totalEnergyKwh":1537.2,"billingPeriodProd":862},{"month":"2024-04","ngStartDate":"2024-04-10","ngEndDate":"2024-05-10","ngCost":0,"ngUsage":0,"ngExport":692,"ngCredit":865.96,"ngProd":1188,"sunrunCost":148.96,"sunrunProd":1279,"gasCost":39.37,"gasTherms":16,"totalProduction":1217,"selfUse":525,"trueConsumption":525,"netPosition":692,"totalCost":148.96,"effectiveRate":0.28373333333333334,"gasKwh":468.8,"totalEnergyCost":188.33,"totalEnergyKwh":993.8,"billingPeriodProd":1217},{"month":"2024-05","ngStartDate":"2024-05-10","ngEndDate":"2024-06-12","ngCost":0,"ngUsage":0,"ngExport":964,"ngCredit":1161.3,"ngProd":1439,"sunrunCost":148.96,"sunrunProd":1365,"gasCost":36.63,"gasTherms":17,"totalProduction":1491,"selfUse":527,"trueConsumption":527,"netPosition":964,"totalCost":148.96,"effectiveRate":0.28265654648956356,"gasKwh":498.1,"totalEnergyCost":185.59,"totalEnergyKwh":1025.1,"billingPeriodProd":1491},{"month":"2024-06","ngStartDate":"2024-06-12","ngEndDate":"2024-07-15","ngCost":37.89,"ngUsage":57,"ngExport":0,"ngCredit":1123.41,"ngProd":1594,"sunrunCost":148.96,"sunrunProd":1427,"gasCost":65.64,"gasTherms":12,"totalProduction":1612,"selfUse":1612,"trueConsumption":1669,"netPosition":-57,"totalCost":186.85000000000002,"effectiveRate":0.11195326542840026,"gasKwh":351.6,"totalEnergyCost":252.49,"totalEnergyKwh":2020.6,"billingPeriodProd":1612},{"month":"2024-07","ngStartDate":"2024-07-15","ngEndDate":"2024-08-14","ngCost":125.29,"ngUsage":318,"ngExport":0,"ngCredit":998.12,"ngProd":1185,"sunrunCost":148.96,"sunrunProd":0,"gasCost":96.06,"gasTherms":13,"totalProduction":1263,"selfUse":1263,"trueConsumption":1581,"netPosition":-318,"totalCost":274.25,"effectiveRate":0.1734661606578115,"gasKwh":380.90000000000003,"totalEnergyCost":370.31,"totalEnergyKwh":1961.9,"billingPeriodProd":1263},{"month":"2024-08","ngStartDate":"2024-08-14","ngEndDate":"2024-09-12","ngCost":79.21,"ngUsage":193,"ngExport":0,"ngCredit":918.91,"ngProd":1131,"sunrunCost":148.96,"sunrunProd":2452,"gasCost":27.19,"gasTherms":11,"totalProduction":1179,"selfUse":1179,"trueConsumption":1372,"netPosition":-193,"totalCost":228.17000000000002,"effectiveRate":0.16630466472303207,"gasKwh":322.3,"totalEnergyCost":255.36,"totalEnergyKwh":1694.3,"billingPeriodProd":1179},{"month":"2024-09","ngStartDate":"2024-09-12","ngEndDate":"2024-10-11","ngCost":120.33,"ngUsage":324,"ngExport":0,"ngCredit":798.58,"ngProd":682,"sunrunCost":148.96,"sunrunProd":646,"gasCost":32.65,"gasTherms":15,"totalProduction":739,"selfUse":739,"trueConsumption":1063,"netPosition":-324,"totalCost":269.29,"effectiveRate":0.2533301975540922,"gasKwh":439.5,"totalEnergyCost":301.94,"totalEnergyKwh":1502.5,"billingPeriodProd":739},{"month":"2024-10","ngStartDate":"2024-10-11","ngEndDate":"2024-11-13","ngCost":168.16,"ngUsage":461,"ngExport":0,"ngCredit":630.42,"ngProd":617,"sunrunCost":148.96,"sunrunProd":578,"gasCost":27.19,"gasTherms":11,"totalProduction":644,"selfUse":644,"trueConsumption":1105,"netPosition":-461,"totalCost":317.12,"effectiveRate":0.2869864253393665,"gasKwh":322.3,"totalEnergyCost":344.31,"totalEnergyKwh":1427.3,"billingPeriodProd":644},{"month":"2024-11","ngStartDate":"2024-11-13","ngEndDate":"2024-12-13","ngCost":528.25,"ngUsage":1509,"ngExport":0,"ngCredit":102.17,"ngProd":415,"sunrunCost":148.96,"sunrunProd":419,"gasCost":35.82,"gasTherms":11,"totalProduction":438,"selfUse":438,"trueConsumption":1947,"netPosition":-1509,"totalCost":677.21,"effectiveRate":0.3478222907036467,"gasKwh":322.3,"totalEnergyCost":713.0300000000001,"totalEnergyKwh":2269.3,"billingPeriodProd":438},{"month":"2024-12","ngStartDate":"2024-12-13","ngEndDate":"2025-01-15","ngCost":931.59,"ngUsage":2692,"ngExport":0,"ngCredit":0,"ngProd":362,"sunrunCost":148.96,"sunrunProd":314,"gasCost":47.75,"gasTherms":16,"totalProduction":379,"selfUse":379,"trueConsumption":3071,"netPosition":-2692,"totalCost":1080.55,"effectiveRate":0.35185607294041027,"gasKwh":468.8,"totalEnergyCost":1128.3,"totalEnergyKwh":3539.8,"billingPeriodProd":379},{"month":"2025-01","ngStartDate":"2025-01-15","ngEndDate":"2025-02-13","ngCost":859.55,"ngUsage":2530,"ngExport":0,"ngCredit":0,"ngProd":300,"sunrunCost":148.96,"sunrunProd":342,"gasCost":56.64,"gasTherms":20,"totalProduction":321,"selfUse":321,"trueConsumption":2851,"netPosition":-2530,"totalCost":1008.51,"effectiveRate":0.35373903893370745,"gasKwh":586,"totalEnergyCost":1065.15,"totalEnergyKwh":3437,"billingPeriodProd":321},{"month":"2025-02","ngStartDate":"2025-02-13","ngEndDate":"2025-03-15","ngCost":347.19,"ngUsage":1471,"ngExport":0,"ngCredit":512.36,"ngProd":722,"sunrunCost":148.96,"sunrunProd":675,"gasCost":57.07,"gasTherms":19,"totalProduction":722,"selfUse":722,"trueConsumption":2193,"netPosition":-1471,"totalCost":496.15,"effectiveRate":0.22624259005927952,"gasKwh":556.7,"totalEnergyCost":553.22,"totalEnergyKwh":2749.7,"billingPeriodProd":722},{"month":"2025-03","ngStartDate":"2025-03-15","ngEndDate":"2025-04-11","ngCost":26,"ngUsage":280,"ngExport":0,"ngCredit":486.36,"ngProd":740,"sunrunCost":153.28,"sunrunProd":826,"gasCost":52.39,"gasTherms":19,"totalProduction":772,"selfUse":772,"trueConsumption":1052,"netPosition":-280,"totalCost":179.28,"effectiveRate":0.17041825095057034,"gasKwh":556.7,"totalEnergyCost":231.67000000000002,"totalEnergyKwh":1608.7,"billingPeriodProd":772},{"month":"2025-04","ngStartDate":"2025-04-11","ngEndDate":"2025-05-15","ngCost":0,"ngUsage":0,"ngExport":422,"ngCredit":598.66,"ngProd":1374,"sunrunCost":153.28,"sunrunProd":1239,"gasCost":54.5,"gasTherms":20,"totalProduction":1424,"selfUse":1002,"trueConsumption":1002,"netPosition":422,"totalCost":153.28,"effectiveRate":0.15297405189620758,"gasKwh":586,"totalEnergyCost":207.78,"totalEnergyKwh":1588,"billingPeriodProd":1424},{"month":"2025-05","ngStartDate":"2025-05-15","ngEndDate":"2025-06-16","ngCost":0,"ngUsage":0,"ngExport":87,"ngCredit":612.27,"ngProd":1224,"sunrunCost":153.28,"sunrunProd":1178,"gasCost":41.94,"gasTherms":13,"totalProduction":1272,"selfUse":1185,"trueConsumption":1185,"netPosition":87,"totalCost":153.28,"effectiveRate":0.12935021097046415,"gasKwh":380.90000000000003,"totalEnergyCost":195.22,"totalEnergyKwh":1565.9,"billingPeriodProd":1272},{"month":"2025-06","ngStartDate":"2025-06-16","ngEndDate":"2025-07-16","ngCost":34.78,"ngUsage":92,"ngExport":0,"ngCredit":577.49,"ngProd":1335,"sunrunCost":153.28,"sunrunProd":1423,"gasCost":41.94,"gasTherms":13,"totalProduction":1383,"selfUse":1383,"trueConsumption":1475,"netPosition":-92,"totalCost":188.06,"effectiveRate":0.12749830508474577,"gasKwh":380.90000000000003,"totalEnergyCost":230,"totalEnergyKwh":1855.9,"billingPeriodProd":1383},{"month":"2025-07","ngStartDate":"2025-07-16","ngEndDate":"2025-08-14","ngCost":16.43,"ngUsage":13,"ngExport":0,"ngCredit":561.06,"ngProd":1414,"sunrunCost":153.28,"sunrunProd":1496,"gasCost":44.23,"gasTherms":14,"totalProduction":1456,"selfUse":1456,"trueConsumption":1469,"netPosition":-13,"totalCost":169.71,"effectiveRate":0.11552756977535739,"gasKwh":410.2,"totalEnergyCost":213.94,"totalEnergyKwh":1879.2,"billingPeriodProd":1456},{"month":"2025-08","ngStartDate":"2025-08-14","ngEndDate":"2025-09-12","ngCost":51.63,"ngUsage":164,"ngExport":0,"ngCredit":509.43,"ngProd":1102,"sunrunCost":153.28,"sunrunProd":1168,"gasCost":46.53,"gasTherms":15,"totalProduction":1133,"selfUse":1133,"trueConsumption":1297,"netPosition":-164,"totalCost":204.91,"effectiveRate":0.15798766383962992,"gasKwh":439.5,"totalEnergyCost":251.44,"totalEnergyKwh":1736.5,"billingPeriodProd":1133},{"month":"2025-09","ngStartDate":"2025-09-12","ngEndDate":"2025-10-14","ngCost":121.27,"ngUsage":455,"ngExport":0,"ngCredit":388.16,"ngProd":800,"sunrunCost":153.28,"sunrunProd":703,"gasCost":60.25,"gasTherms":21,"totalProduction":846,"selfUse":846,"trueConsumption":1301,"netPosition":-455,"totalCost":274.55,"effectiveRate":0.21102997694081477,"gasKwh":615.3000000000001,"totalEnergyCost":334.8,"totalEnergyKwh":1916.3000000000002,"billingPeriodProd":846},{"month":"2025-10","ngStartDate":"2025-10-14","ngEndDate":"2025-11-12","ngCost":124.85,"ngUsage":499,"ngExport":0,"ngCredit":263.31,"ngProd":441,"sunrunCost":153.28,"sunrunProd":479,"gasCost":55.01,"gasTherms":20,"totalProduction":441,"selfUse":441,"trueConsumption":940,"netPosition":-499,"totalCost":278.13,"effectiveRate":0.29588297872340424,"gasKwh":586,"totalEnergyCost":333.14,"totalEnergyKwh":1526,"billingPeriodProd":441},{"month":"2025-11","ngStartDate":"2025-11-12","ngEndDate":"2025-12-12","ngCost":494.75,"ngUsage":2249,"ngExport":0,"ngCredit":0,"ngProd":400,"sunrunCost":153.28,"sunrunProd":391,"gasCost":0,"gasTherms":22,"totalProduction":413,"selfUse":413,"trueConsumption":2662,"netPosition":-2249,"totalCost":648.03,"effectiveRate":0.2434372652141247,"gasKwh":644.6,"totalEnergyCost":648.03,"totalEnergyKwh":3306.6,"billingPeriodProd":413},{"month":"2025-12","ngStartDate":"2025-12-12","ngEndDate":"2026-01-14","ngCost":778.51,"ngUsage":3592,"ngExport":0,"ngCredit":0,"ngProd":311,"sunrunCost":153.28,"sunrunProd":297,"gasCost":0,"gasTherms":0,"totalProduction":331,"selfUse":331,"trueConsumption":3923,"netPosition":-3592,"totalCost":931.79,"effectiveRate":0.2375197552893194,"gasKwh":0,"totalEnergyCost":931.79,"totalEnergyKwh":3923,"billingPeriodProd":331},{"month":"2026-01","ngStartDate":"2026-01-14","ngEndDate":"2026-02-11","ngCost":658.26,"ngUsage":3325,"ngExport":0,"ngCredit":0,"ngProd":111,"sunrunCost":0,"sunrunProd":0,"gasCost":0,"gasTherms":0,"totalProduction":131,"selfUse":131,"trueConsumption":3456,"netPosition":-3325,"totalCost":658.26,"effectiveRate":0.19046875,"gasKwh":0,"totalEnergyCost":658.26,"totalEnergyKwh":3456,"billingPeriodProd":131}];
        let currentData = [...allData];
        const charts = {};
        let isAreaChart = false;

        // Common Options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
        };

        const currencyOptions = {
            ...commonOptions,
            scales: {
                y: {
                    ticks: {
                        callback: function(value) { return '$' + value; }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        };

        const kwhOptions = {
            ...commonOptions,
            scales: {
                y: {
                    ticks: {
                        callback: function(value) { return value + ' kWh'; }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y + ' kWh';
                            }
                            return label;
                        }
                    }
                }
            }
        };

        function getChartData(data) {
            return {
                labels: data.map(d => d.month),
                ngCosts: data.map(d => d.ngCost),
                sunrunCosts: data.map(d => d.sunrunCost),
                totalCosts: data.map(d => d.totalCost),
                ngUsage: data.map(d => d.ngUsage),
                totalProduction: data.map(d => d.totalProduction),
                trueConsumption: data.map(d => d.trueConsumption),
                selfUse: data.map(d => d.selfUse),
                ngExport: data.map(d => d.ngExport),
                ngCredit: data.map(d => d.ngCredit),
                effectiveRate: data.map(d => d.effectiveRate),
                gasCost: data.map(d => d.gasCost),
                gasKwh: data.map(d => d.gasKwh),
                totalEnergyCosts: data.map(d => d.totalEnergyCost),
                ngProd: data.map(d => d.ngProd),
                sunrunProd: data.map(d => d.sunrunProd),
                billingPeriodProd: data.map(d => d.billingPeriodProd)
            };
        }

        function renderCharts() {
            const d = getChartData(currentData);

            // 1. Total Cost Chart
            charts.totalCost?.destroy();
            charts.totalCost = new Chart(document.getElementById('totalCostChart'), {
                type: 'bar',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'Gas Bill', data: d.gasCost, backgroundColor: '#e74c3c', stack: 'Stack 0' },
                        { label: 'Electric Bill', data: d.ngCosts, backgroundColor: '#3498db', stack: 'Stack 0' },
                        { label: 'Solar Bill', data: d.sunrunCosts, backgroundColor: '#f1c40f', stack: 'Stack 0' },
                        { label: 'Total Spend', data: d.totalEnergyCosts, type: 'line', borderColor: '#2c3e50', borderWidth: 2, fill: false, tension: 0.1 }
                    ]
                },
                options: currencyOptions
            });

            // 2. Total Energy Chart
            charts.totalEnergy?.destroy();
            charts.totalEnergy = new Chart(document.getElementById('totalEnergyChart'), {
                type: 'bar',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'Gas (kWh equiv)', data: d.gasKwh, backgroundColor: '#e74c3c', stack: 'Stack 0' },
                        { label: 'Electric Consumed', data: d.trueConsumption, backgroundColor: '#3498db', stack: 'Stack 0' }
                    ]
                },
                options: kwhOptions
            });

            // 3. Consumption Chart (Toggleable)
            renderConsumptionChart(d);

            // 4. Net Zero Chart
            charts.netZero?.destroy();
            charts.netZero = new Chart(document.getElementById('netZeroChart'), {
                type: 'line',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'Solar Production', data: d.totalProduction, borderColor: '#f1c40f', backgroundColor: 'rgba(241, 196, 15, 0.1)', fill: true, tension: 0.3 },
                        { label: 'True Consumption', data: d.trueConsumption, borderColor: '#34495e', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.3 }
                    ]
                },
                options: kwhOptions
            });

            // 5. Credit Chart
            charts.credit?.destroy();
            charts.credit = new Chart(document.getElementById('creditChart'), {
                type: 'line',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'Credit Balance ($)', data: d.ngCredit, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: currencyOptions
            });

            // 6. Cost Chart
            charts.cost?.destroy();
            charts.cost = new Chart(document.getElementById('costChart'), {
                type: 'bar',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'National Grid', data: d.ngCosts, backgroundColor: '#3498db', stack: 'Stack 0' },
                        { label: 'Sunrun', data: d.sunrunCosts, backgroundColor: '#f1c40f', stack: 'Stack 0' },
                        { label: 'Total Cost', data: d.totalCosts, type: 'line', borderColor: '#e74c3c', borderWidth: 2, fill: false }
                    ]
                },
                options: currencyOptions
            });

            // 7. Rate Chart
            charts.rate?.destroy();
            charts.rate = new Chart(document.getElementById('rateChart'), {
                type: 'line',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'Effective $/kWh', data: d.effectiveRate, borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '$/kWh' } }
                    }
                }
            });

            // 8. Utilization Chart
            charts.utilization?.destroy();
            charts.utilization = new Chart(document.getElementById('utilizationChart'), {
                type: 'bar',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'Used at Home', data: d.selfUse, backgroundColor: '#f1c40f', stack: 'Stack 0' },
                        { label: 'Sent to Grid', data: d.ngExport, backgroundColor: '#95a5a6', stack: 'Stack 0' }
                    ]
                },
                options: kwhOptions
            });

            // 9. Production Comparison Chart
            charts.productionComparison?.destroy();
            charts.productionComparison = new Chart(document.getElementById('productionComparisonChart'), {
                type: 'bar',
                data: {
                    labels: d.labels,
                    datasets: [
                        { label: 'National Grid Credited', data: d.ngProd, backgroundColor: '#3498db' },
                        { label: 'Sunrun Actual (Billing Period)', data: d.billingPeriodProd, backgroundColor: '#f1c40f' }
                    ]
                },
                options: kwhOptions
            });
        }

        function renderConsumptionChart(d) {
            charts.consumption?.destroy();

            charts.consumption = new Chart(document.getElementById('consumptionChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: d.labels,
                    datasets: [
                        {
                            label: 'Imported from Grid',
                            data: d.ngUsage,
                            backgroundColor: '#3498db',
                            borderColor: '#3498db',
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Solar Self-Use',
                            data: d.selfUse,
                            backgroundColor: '#f1c40f',
                            borderColor: '#f1c40f',
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Total Consumption',
                            data: d.trueConsumption,
                            type: 'line',
                            borderColor: '#34495e',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }
                    ]
                },
                options: kwhOptions
            });
        }

        // Initialize Year Select
        function initYearSelect() {
            const years = [...new Set(allData.map(d => d.month.split('-')[0]))].sort().reverse();
            const select = document.getElementById('yearSelect');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                const year = e.target.value;
                if (year === 'all') {
                    currentData = [...allData];
                } else {
                    currentData = allData.filter(d => d.month.startsWith(year));
                }
                renderCharts();
            });
        }

        // Start
        initYearSelect();
        renderCharts();

    </script>
</body>
</html>
